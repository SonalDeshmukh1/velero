name: Pull Request CI Check
on: [pull_request]
jobs:
  get-go-version:
    uses: ./.github/workflows/get-go-version.yaml
    with:
      ref: ${{ github.event.pull_request.base.ref }}

  build:
    name: Run CI
    needs: get-go-version
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    steps:
      - name: Check out the code
        uses: actions/checkout@v6

      - name: Set up Go version
        uses: actions/setup-go@v6
        with:
          go-version: ${{ needs.get-go-version.outputs.version }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run main CI tests
        run: make ci

      - name: Build for s390x architecture
        run: |
          echo "Building Velero for s390x architecture..."
          
          # Build using the existing Makefile target
          ARCH=linux-s390x make build
          
          # Verify the binary was created
          if [ ! -f "_output/bin/linux/s390x/velero" ]; then
            echo "ERROR: s390x binary not created!"
            exit 1
          fi
          
          # Show binary information
          echo "Binary details:"
          ls -lh _output/bin/linux/s390x/velero
          file _output/bin/linux/s390x/velero
          
          echo "âœ… s390x compilation successful"
